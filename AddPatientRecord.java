/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */

import com.formdev.flatlaf.FlatLaf;
import com.formdev.flatlaf.FlatClientProperties;
import com.formdev.flatlaf.themes.FlatMacLightLaf;
import com.formdev.flatlaf.fonts.roboto.FlatRobotoFont;
import net.miginfocom.swing.MigLayout;
import com.opencsv.CSVWriter;

import javax.swing.*;
import java.awt.*;
import java.io.FileWriter;
import java.io.IOException;
import java.util.List;
/**
 * @author adm
 */
public class AddPatientRecord extends JFrame {

    /**
     * Creates new form addPatient
     */
    // Variables declaration
    private static List<Doctor> allDoctors;
    private final String REGEX_FOR_NAME = "^[A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ]" +
            "[a-zàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]" +
            "*(?:[ ][A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸĐ]" +
            "[a-zàáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ]*)*$";
    private int numOfPatientToday = 1;

    private JButton saveButton;
    private JComboBox<String> genderBox;
    private JComboBox<String> departmentBox;
    private JRadioButton jrMale;
    private JRadioButton jrFemale;
    private ButtonGroup groupGender;
//    private JLabel idLabel;
//    private JLabel logoLabel;
//    private JLabel nameLabel;
//    private JLabel phoneNumberLabel;
//    private JLabel addressLabel;
//    private JLabel ageLabel;
//    private JLabel genderLabel;
//    private JLabel historyLabel;
//    private JLabel toDepartmentLabel;
    private JTextField idTextField;
    private JTextField txtFirstName;
    private JTextField txtLastName;
    private JTextField txtPhoneNumber;
    private JTextField txtAge;
    private JTextField txtAddress;
    private JTextField txtHistory;

    public AddPatientRecord() {
        FlatRobotoFont.install();
        FlatLaf.registerCustomDefaultsSource("raven.themes");
        UIManager.put("defaultFont", new Font(FlatRobotoFont.FAMILY, Font.PLAIN, 13));
        FlatMacLightLaf.setup();
        setTitle("Thêm bệnh nhân");
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setSize(new Dimension(1200, 800));
        setLocationRelativeTo(null);
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        idTextField = new JTextField(numOfPatientToday + "");
        txtFirstName = new JTextField();
        txtLastName = new JTextField();
        txtPhoneNumber = new JTextField();
        txtAge = new JTextField();
        txtAddress = new JTextField();
        txtHistory = new JTextField();

        genderBox = new JComboBox<>();
        departmentBox = new JComboBox<>();

        saveButton = new JButton("Lưu");

        setCursor(new Cursor(Cursor.DEFAULT_CURSOR));
        setLayout(new MigLayout("fill,insets 20", "[center]", "[center]"));

        JPanel panel = new JPanel(new MigLayout("wrap,fillx,insets 35 45 30 45", "[fill,360]"));
        panel.putClientProperty(FlatClientProperties.STYLE, "arc:20;" +
                "[light]background:darken(@background,3%);" +
                "[dark]background:lighten(@background,3%)");

        txtFirstName.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Họ");
        txtLastName.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Tên");
        txtPhoneNumber.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Số điện thoại");
        txtAddress.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Địa chỉ");
        txtAge.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Tuổi");
        txtHistory.putClientProperty(FlatClientProperties.PLACEHOLDER_TEXT, "Tiền sử bệnh án");
        departmentBox.setModel(new DefaultComboBoxModel<>(new String[]{"Khoa Nội", "Khoa Ngoại", "Khoa Phụ sản",
                "Khoa Tai-Mũi-Họng", "Khoa Hồi sức tích cực", "Khoa Răng-Hàm-Mặt", "Khoa Ung bướu", "Khoa Cấp cứu", "Khoa Xương khớp"}));


        saveButton.putClientProperty(FlatClientProperties.STYLE, "[light]background:darken(@background,10%);" +
                "[dark]background:lighten(@background,10%);" +
                "borderWidth:0;" +
                "focusWidth:0;" +
                "innerFocusWidth:0");
        saveButton.addActionListener(this::saveButtonActionPerformed);

        JLabel lbTitle = new JLabel("Thông tin bệnh nhân");
        lbTitle.putClientProperty(FlatClientProperties.STYLE, "font:bold +10");


        panel.add(lbTitle);

        panel.add(new JLabel("ID"), "gapy 8");
        panel.add(idTextField);
        panel.add(new JLabel("Họ và tên"), "gapy 8");
        panel.add(txtFirstName, "split 2");
        panel.add(txtLastName);
        panel.add(new JLabel("Giới tính"), "gapy 8");
        panel.add(createGenderPanel());
        panel.add(new JSeparator(), "gapy 5 5");
        panel.add(new JLabel("Số điện thoại"), "gapy 8");
        panel.add(txtPhoneNumber);
        panel.add(new JLabel("Tuổi"), "gapy 8");
        panel.add(txtAge);
        panel.add(new JLabel("Địa chỉ"), "gapy 8");
        panel.add(txtAddress);
        panel.add(new JLabel("Tiền sử bệnh án"), "gapy 8");
        panel.add(txtHistory);
        panel.add(new JLabel("Khoa"), "gapy 8");
        panel.add(departmentBox);
        panel.add(saveButton, "gapy 20");

        add(panel);
    }

    private String getGender() {
        if (jrMale.isSelected()) {
            return "Nam";
        } else {
            return "Nữ";
        }
    }
    private Component createGenderPanel() {
        JPanel panel = new JPanel(new MigLayout("insets 0"));
        panel.putClientProperty(FlatClientProperties.STYLE, "background:null");
        jrMale = new JRadioButton("Male");
        jrFemale = new JRadioButton("Female");
        groupGender = new ButtonGroup();
        groupGender.add(jrMale);
        groupGender.add(jrFemale);
        jrMale.setSelected(true);
        panel.add(jrMale);
        panel.add(jrFemale);
        return panel;
    }

    private void saveButtonActionPerformed(java.awt.event.ActionEvent evt) {
        try {
            int id = Integer.parseInt(idTextField.getText());
            int age = Integer.parseInt(txtAge.getText());

            if (age <= 0) {
                JOptionPane.showMessageDialog(this, "Tuổi phải là số nguyên dương.", "Lỗi", JOptionPane.ERROR_MESSAGE);
                return;
            }

            String name = txtFirstName.getText() + " " + txtLastName.getText();
            if (!name.matches(REGEX_FOR_NAME)) {
                JOptionPane.showMessageDialog(this, "Tên phải là chuỗi hợp lệ.", "Lỗi", JOptionPane.ERROR_MESSAGE);
                return;
            }

            String address = txtAddress.getText();
            String phone = txtPhoneNumber.getText();
            String history = txtHistory.getText();

            if (address.isEmpty() || phone.isEmpty() || history.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Vui lòng nhập đầy đủ thông tin của bệnh nhân.", "Lỗi", JOptionPane.ERROR_MESSAGE);
                return;
            }
            if (!phone.matches("^\\d+$")) {
                JOptionPane.showMessageDialog(this, "Số điện thoại không hợp lệ.", "Lỗi", JOptionPane.ERROR_MESSAGE);
                return;
            }
            if (phone.length() != 10) {
                JOptionPane.showMessageDialog(this, "Số điện thoại phải có 10 chữ số.", "Lỗi", JOptionPane.ERROR_MESSAGE);
                return;
            }

            String gender = getGender();
            String department = String.valueOf(departmentBox.getSelectedItem());
//            Doctor selectedDoctor = findDoctorByDepartment(department);
//            if (selectedDoctor != null) {
//                selectedDoctor.addPatientToQueue(patient);
//            }

            // Success
            String[] patient = new String[]{id + "", name, phone, age + "", gender, address, history};
            switch (department) {
                case "Khoa Nội":
                    writeToCSV(patient, "csv/khoanoi.csv");
                    break;
                case "Khoa Ngoại":
                    writeToCSV(patient, "csv/khoangoai.csv");
                    break;
                case "Khoa Phụ sản":
                    writeToCSV(patient, "csv/khoaphusan.csv");
                    break;
                case "Khoa Tai-Mũi-Họng":
                    writeToCSV(patient, "csv/khoataimuihong.csv");
                    break;
                case "Khoa Hồi sức tích cực":
                    writeToCSV(patient, "csv/khoahoisuctichcuc.csv");
                    break;
                case "Khoa Răng-Hàm-Mặt":
                    writeToCSV(patient, "csv/khoaranghammat.csv");
                    break;
                case "Khoa Ung bướu":
                    writeToCSV(patient, "csv/khoaungbuou.csv");
                    break;
                case "Khoa Xương khớp":
                    writeToCSV(patient, "csv/khoaxuongkhop.csv");
                    break;
            }
            JOptionPane.showMessageDialog(this, "Thêm bệnh nhân thành công.");

            // Update UI
            numOfPatientToday++;
            idTextField.setText(numOfPatientToday + "");
            txtFirstName.setText("");
            txtLastName.setText("");
            jrMale.setSelected(true);
            txtPhoneNumber.setText("");
            txtAge.setText("");
            txtAddress.setText("");
            txtHistory.setText("");

        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, "ID và tuổi phải là số nguyên.", "Lỗi", JOptionPane.ERROR_MESSAGE);
        }
    }

//    private Doctor findDoctorByDepartment(String department) {
//        for (Doctor doctor : allDoctors) {
//            if (doctor.getDepartment().equals(department)) {
//                return doctor;
//            }
//        }
//        return null;
//    }
    public void writeToCSV(String[] data, String fileLocation) {
        String csv = fileLocation;
        try {
            CSVWriter writer = new CSVWriter(new FileWriter(csv, true));
            writer.writeNext(data);
            writer.close();
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
